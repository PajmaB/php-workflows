name: Reusable PHP Login Workflow

on:
  workflow_call:
    inputs:
      php_version:
        required: false
        default: '8.1'
        type: string

jobs:
  login-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório chamador
        uses: actions/checkout@v3

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php_version }}

      - name: Instalar dependências (se existir composer.json)
        run: |
          if [ -f "composer.json" ]; then
            composer install
          else
            echo "Nenhum composer.json encontrado — seguindo..."
          fi

      - name: Criar teste básico de login (caso não exista)
        run: |
          if [ ! -d "tests" ]; then
            echo "Criando pasta de testes..."
            mkdir -p tests
          fi

          if [ ! -f "tests/LoginTest.php" ]; then
            echo "Gerando teste básico para validar o login..."
cat << 'EOF' > tests/LoginTest.php
<?php

use PHPUnit\Framework\TestCase;

class LoginTest extends TestCase {
    public function testLoginSimulation() {
        $_POST["username"] = "admin";
        $_POST["password"] = "novaSenha";

        ob_start();
        include "index.php"; // Ajuste para o arquivo correto se necessário
        ob_end_clean();

        $this->assertTrue($_SESSION["loggedin"] ?? false);
        $this->assertEquals("admin", $_SESSION["username"] ?? "");
    }
}
EOF
          fi

      - name: Executar testes PHPUnit ou fallback
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/php
